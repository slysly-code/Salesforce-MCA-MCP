# CMS MCP Server Enhancement: Complex Email Builder

## Progress Tracker
- [x] Step 1: Read MCE MCP Server MASTER-GUIDE.md
- [x] Step 2: Read MCE MCP Server main files (preflight check pattern)
- [x] Step 3: Fetch complex email content (MCSSLY4WPOFZFBXAY2UXF75KRYPQ)
- [x] Step 4: Document learnings (this file)
- [x] Step 5: Implement preflight check for CMS MCP ✅ COMPLETE

---

## Implementation Summary (v2.0.0)

### New Tools Added

| Tool | Purpose |
|------|---------|
| `cms_preflight_check` | Mandatory check before email creation, issues clearance token |
| `cms_validate_request` | Validates email structure before API call |

### Enhanced Tools

| Tool | Enhancement |
|------|-------------|
| `get_api_guide` | New topics: "master-guide", "sections" |
| `create_cms_content` | Requires clearance token for emails |

### Key Features

1. **Clearance Token System**
   - Token generated by preflight check
   - Valid for 30 minutes
   - Single-use (deleted after successful creation)
   - Required for email creation

2. **Validation System**
   - Checks all block IDs are valid UUIDs
   - Validates hierarchy (root → section → column → component)
   - Reports errors and warnings separately

3. **Comprehensive Documentation**
   - Master guide with complete examples
   - Section templates (copy-paste ready)
   - User language → component mapping

---

## Complex Email Structure Analysis (MCSSLY4WPOFZFBXAY2UXF75KRYPQ)

### Email Sections (6 total)
1. **Banner Image** (full width) - `lightning/image` in section with columnWidth: 12
2. **Heading** - `lightning/heading` with level 3
3. **Paragraph** (intro text) - `lightning/paragraph` with body copy
4. **Two Columns** - Section with TWO `lightning/column` children (columnWidth: 6 each)
   - Left: Image (`lightning/image`)
   - Right: Paragraph (`lightning/paragraph`)
5. **Button** - `lightning/actionButton` centered
6. **Footer Paragraph** - `lightning/paragraph` with organization address

### Structure Pattern
```
sfdc_cms/rootContentBlock
├── Section 1: Banner (columnWidth: 12)
│   └── Column
│       └── Image
├── Section 2: Heading (columnWidth: 12)
│   └── Column
│       └── Heading
├── Section 3: Body Text (columnWidth: 12)
│   └── Column
│       └── Paragraph
├── Section 4: Two Columns (columnWidth: 6 + 6)
│   ├── Column Left
│   │   └── Image
│   └── Column Right
│       └── Paragraph
├── Section 5: CTA Button (columnWidth: 12)
│   └── Column
│       └── ActionButton
└── Section 6: Footer (columnWidth: 12)
    └── Column
        └── Paragraph
```

---

## User Language → CMS Component Mapping

| User Says | CMS Component | Implementation |
|-----------|---------------|----------------|
| "banner image", "hero" | Image (full width) | Section → Column (12) → Image |
| "headline", "heading", "title" | Heading | Section → Column (12) → Heading |
| "paragraph", "text", "body" | Paragraph | Section → Column (12) → Paragraph |
| "2 columns", "side by side" | Multi-column section | Section → [Column (6), Column (6)] |
| "image left, text right" | 2-col with specific content | Section → [Col→Image, Col→Paragraph] |
| "button", "CTA", "call to action" | ActionButton | Section → Column (12) → ActionButton |
| "footer", "imprint" | Paragraph (footer style) | Section → Column (12) → Paragraph |
| "custom HTML" | HTML block | Section → Column (12) → HTML |

---

## LLM Workflow

```
1. User requests email creation
   │
2. LLM calls cms_preflight_check
   │ ← Returns clearance token + documentation URIs
   │
3. LLM calls get_api_guide with topic: "master-guide"
   │ ← Reads complete documentation
   │
4. LLM builds email JSON structure
   │ ← Uses section templates, generates UUIDs
   │
5. LLM calls cms_validate_request
   │ ← Validates structure before API call
   │
6. If validation passes:
   │ LLM calls create_cms_content with clearance_token
   │ ← Email created successfully
   │
7. If validation fails:
   │ LLM fixes errors and re-validates
   └── Loop until valid
```

---

## Testing Checklist

- [ ] Restart Claude Desktop to load new MCP server
- [ ] Verify version with `server_version` tool
- [ ] Test preflight check generates token
- [ ] Test validation catches invalid UUIDs
- [ ] Test email creation requires clearance token
- [ ] Test complex email with multiple sections

---

## Files Modified

| File | Changes |
|------|---------|
| `src/index.js` | Added preflight check, validation, enhanced guide |
| `package.json` | Updated version to 2.0.0 |
| `.docs/ENHANCEMENT-PROGRESS.md` | This documentation |
